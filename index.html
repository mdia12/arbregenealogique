<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Arbre Généalogique Complet</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        /* CSS global */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0; padding: 0; overflow: hidden; background-color: #f0f2f5;
        }
        #tree-container { width: 100vw; height: 100vh; cursor: move; display: block; }

        /* Liens & Nœuds */
        .link { fill: none; stroke: #b0bec5; stroke-width: 2px; }
        .node circle { stroke: #fff; stroke-width: 3px; cursor: pointer; }
        .node.is-spouse rect { stroke: #fff; stroke-width: 3px; cursor: pointer; }
        .node text {
            font-size: 14px; fill: #263238; paint-order: stroke;
            stroke: #fff; stroke-width: 3.5px; stroke-linecap: butt; stroke-linejoin: miter;
        }
        .spouse-link { fill: none; stroke: #78909c; stroke-width: 1.5px; stroke-dasharray: 4 2; }

        /* Couleurs par génération */
        .generation-0 { fill: #455a64; }
        .generation-1 { fill: #546e7a; }
        .generation-2 { fill: #78909c; }
        .generation-3 { fill: #90a4ae; }
        .generation-4 { fill: #b0bec5; }

        /* Panneau de détails */
        #details-panel {
            position: absolute; top: 20px; right: 20px; width: 290px;
            background-color: white; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.1);
            padding: 20px; display: none; transition: opacity 0.3s ease; opacity: 0;
            max-height: calc(100vh - 40px); overflow-y: auto;
        }
        #details-panel.visible { display: block; opacity: 1; }
        #details-panel img {
            width: 100px; height: 100px; border-radius: 50%; display: block;
            margin: 0 auto 15px; object-fit: cover; border: 4px solid #eceff1;
        }
        #details-panel h3 { margin: 0 0 10px; text-align: center; color: #263238; font-size: 20px; }
        #details-panel p { font-size: 14px; color: #546e7a; margin: 5px 0; text-align: center; }
        .spouse-info { font-style: italic; color: #546e7a; }

        /* Éléments UI du panneau */
        .divider { height: 1px; background: #e0e0e0; margin: 16px 0; }
        .panel-section-title {
            font-size: 14px; font-weight: 600; color: #37474f;
            margin-bottom: 12px; text-align: left;
        }
        form label { display: block; font-size: 13px; color: #555; margin-bottom: 5px; }
        form input {
            width: 100%; box-sizing: border-box; padding: 9px 12px;
            border: 1px solid #cfd8dc; border-radius: 8px; margin-bottom: 12px; font-size: 14px;
        }
        .btn, button {
            width: 100%; padding: 10px 12px; border: 0; border-radius: 8px;
            font-weight: 600; cursor: pointer; transition: filter 0.2s;
            font-size: 14px; margin-top: 5px;
        }
        .btn:hover, button:hover { filter: brightness(1.1); }
        .btn-primary { background: #455a64; color: #fff; }
        .btn-secondary { background: #eceff1; color: #37474f; }
        .btn-danger { background: #d32f2f; color: #fff; }
        .btn-group { display: flex; gap: 8px; }

        .feedback { font-size: 13px; margin-top: 8px; text-align: left; padding: 8px; border-radius: 6px; }
        .success { color: #2e7d32; background-color: #e8f5e9; }
        .error { color: #c62828; background-color: #ffcdd2; }
    </style>
</head>
<body>
    <script>
        const requiredPassword = "famille2025";
        let userPassword = prompt("Entrez le mot de passe pour accéder à l'arbre :");
        if (userPassword !== requiredPassword) {
            document.body.innerHTML = "<h2 style='text-align:center;margin-top:50px'>⛔ Accès refusé. Le mot de passe est incorrect.</h2>";
            throw new Error("Accès refusé"); // Arrête l'exécution du reste du script
        }
    </script>

    <svg id="tree-container"></svg>

    <div id="details-panel">
        <div id="view-mode">
            <img id="person-image" src="" alt="Photo"/>
            <h3 id="person-name"></h3>
            <p id="person-birth"></p>
            <p id="person-death"></p>
            <p id="person-spouse" class="spouse-info"></p>
            <div class="btn-group">
                <button id="edit-btn" class="btn-secondary">Modifier</button>
                <button id="delete-btn" class="btn-danger">Supprimer</button>
            </div>
            <div class="divider"></div>
            <div id="add-child-section">
                 <div class="panel-section-title">Ajouter un enfant</div>
                 <form id="add-child-form">
                     <input name="name" type="text" placeholder="Nom complet de l'enfant" required />
                     <button type="submit" class="btn-primary">Ajouter l'enfant</button>
                 </form>
            </div>
            <div id="add-spouse-section">
                <div class="panel-section-title">Ajouter un conjoint</div>
                <form id="add-spouse-form">
                    <input name="name" type="text" placeholder="Nom complet du conjoint" required />
                    <button type="submit" class="btn-primary">Ajouter le conjoint</button>
                </form>
            </div>
        </div>

        <div id="edit-mode" style="display:none;">
            <div class="panel-section-title">Modifier les informations</div>
            <form id="edit-form">
                <label>Nom complet</label>
                <input name="name" type="text" required />
                <label>Date de naissance (YYYY-MM-DD)</label>
                <input name="birthDate" type="text" />
                <label>Date de décès (YYYY-MM-DD)</label>
                <input name="deathDate" type="text" />
                <label>URL de la photo</label>
                <input name="imageUrl" type="url" />
                <div class="btn-group">
                    <button type="submit" class="btn-primary">Enregistrer</button>
                    <button type="button" id="cancel-edit-btn" class="btn-secondary">Annuler</button>
                </div>
            </form>
        </div>
        <div id="feedback-zone" class="feedback" style="display:none;"></div>
    </div>

    <script>
        // --- 1. GESTION DES DONNÉES & PERSISTANCE ---
        let treeData;
        
        const defaultTreeData = { /* Données initiales si aucune sauvegarde n'existe */
          "name": "Bernard Blerald", "birthDate": "1930-05-15", "deathDate": "2015-10-20", "imageUrl": "https://i.pravatar.cc/150?u=bernard",
          "spouse": { "name": "Jeanne Blerald", "birthDate": "1932-01-01", "deathDate": "2018-12-24", "imageUrl": "https://i.pravatar.cc/150?u=jeanne" },
          "children": [{
              "name": "Jean Dubois", "birthDate": "1955-02-25", "imageUrl": "https://i.pravatar.cc/150?u=jean",
              "children": [{ "name": "Clara Dubois", "birthDate": "1982-11-10", "imageUrl": "https://i.pravatar.cc/150?u=clara", "children": [] }]
          }]
        };

        function saveData() {
            localStorage.setItem('familyTreeData', JSON.stringify(treeData));
            console.log("Arbre sauvegardé !");
        }

        function loadData() {
            const savedData = localStorage.getItem('familyTreeData');
            treeData = savedData ? JSON.parse(savedData) : JSON.parse(JSON.stringify(defaultTreeData));
        }

        // --- 2. CONFIG D3.JS ---
        const svg = d3.select("#tree-container");
        const g = svg.append("g").attr("transform", "translate(150,0)");
        const detailsPanel = d3.select("#details-panel");
        let selectedPerson = null;
        let selectedD3Node = null;

        const zoomHandler = d3.zoom().scaleExtent([0.3, 3]).on("zoom", (event) => g.attr("transform", event.transform));
        svg.call(zoomHandler);

        // --- 3. FONCTION DE RENDU PRINCIPALE ---
        function renderTree() {
            const width = window.innerWidth;
            const height = window.innerHeight;
            svg.attr("width", width).attr("height", height);

            const treeLayout = d3.tree().nodeSize([100, 250]);
            const root = d3.hierarchy(treeData);
            treeLayout(root);
            
            g.selectAll("*").remove(); // Nettoyer avant de redessiner

            // Liens hiérarchiques
            g.append("g").selectAll(".link")
                .data(root.links()).enter()
                .append("path").attr("class", "link")
                .attr("d", d3.linkHorizontal().x(d => d.y).y(d => d.x));

            // Nœuds (personnes et conjoints)
            const node = g.append("g").selectAll(".node")
                .data(root.descendants()).enter()
                .append("g").attr("class", "node")
                .attr("transform", d => `translate(${d.y},${d.x})`);

            // Nœuds principaux (lignée directe)
            node.append("circle").attr("r", 12)
                .attr("class", d => `generation-${d.depth}`)
                .on("click", (event, d) => showDetails(d));
            
            node.append("text").attr("dy", "-1.5em")
                .attr("x", 0).attr("text-anchor", "middle")
                .text(d => d.data.name);

            // Nœuds des conjoints
            const spouseNodes = node.filter(d => d.data.spouse);
            
            spouseNodes.append("rect")
                .attr("class", d => `generation-${d.depth}`)
                .attr("width", 24).attr("height", 24)
                .attr("x", 30).attr("y", -12)
                .on("click", (event, d) => showDetails(d, true));

            spouseNodes.append("text")
                .attr("dy", "-1.5em").attr("x", 42)
                .attr("text-anchor", "middle")
                .text(d => d.data.spouse.name);

            spouseNodes.append("path")
                .attr("class", "spouse-link")
                .attr("d", "M12,0 H30");
        }

        // --- 4. PANNEAU DE DÉTAILS ET ACTIONS ---
        function showDetails(d3Node, isSpouse = false) {
            selectedD3Node = d3Node;
            selectedPerson = isSpouse ? d3Node.data.spouse : d3Node.data;
            const personData = selectedPerson;

            detailsPanel.classed("visible", true);
            switchToViewMode();

            // Affichage des informations
            detailsPanel.select("#person-image").attr("src", personData.imageUrl || "https://via.placeholder.com/100");
            detailsPanel.select("#person-name").text(personData.name);
            detailsPanel.select("#person-birth").text(`Naissance : ${personData.birthDate || "Inconnue"}`);
            const deathEl = detailsPanel.select("#person-death");
            personData.deathDate ? deathEl.text(`Décès : ${personData.deathDate}`).style("display", "block") : deathEl.style("display", "none");

            // Affichage du conjoint
            const spouseInfoEl = detailsPanel.select("#person-spouse");
            const mainPerson = d3Node.data;
            if (isSpouse) {
                 spouseInfoEl.text(`Conjoint(e) de ${mainPerson.name}`).style("display", "block");
            } else if (mainPerson.spouse) {
                spouseInfoEl.text(`Conjoint(e) : ${mainPerson.spouse.name}`).style("display", "block");
            } else {
                spouseInfoEl.style("display", "none");
            }

            // Gérer la visibilité des formulaires
            document.getElementById('add-child-section').style.display = isSpouse ? 'none' : 'block';
            document.getElementById('add-spouse-section').style.display = !isSpouse && !d3Node.data.spouse ? 'block' : 'none';
        }

        function showFeedback(message, type = 'success') {
            const el = document.getElementById('feedback-zone');
            el.textContent = message;
            el.className = `feedback ${type}`;
            el.style.display = 'block';
            setTimeout(() => { el.style.display = 'none'; }, 3000);
        }

        function switchToViewMode() {
            document.getElementById('view-mode').style.display = 'block';
            document.getElementById('edit-mode').style.display = 'none';
        }

        function switchToEditMode() {
            document.getElementById('view-mode').style.display = 'none';
            document.getElementById('edit-mode').style.display = 'block';

            // Pré-remplir le formulaire d'édition
            const form = document.getElementById('edit-form');
            form.elements['name'].value = selectedPerson.name || '';
            form.elements['birthDate'].value = selectedPerson.birthDate || '';
            form.elements['deathDate'].value = selectedPerson.deathDate || '';
            form.elements['imageUrl'].value = selectedPerson.imageUrl || '';
        }
        
        // --- 5. GESTIONNAIRES D'ÉVÉNEMENTS ---

        // Bouton Modifier
        document.getElementById('edit-btn').addEventListener('click', switchToEditMode);
        document.getElementById('cancel-edit-btn').addEventListener('click', switchToViewMode);
        
        // Soumission du formulaire d'édition
        document.getElementById('edit-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const form = e.target;
            selectedPerson.name = form.elements['name'].value.trim();
            selectedPerson.birthDate = form.elements['birthDate'].value.trim() || null;
            selectedPerson.deathDate = form.elements['deathDate'].value.trim() || null;
            selectedPerson.imageUrl = form.elements['imageUrl'].value.trim() || null;
            
            saveData();
            renderTree();
            showDetails(selectedD3Node, selectedPerson !== selectedD3Node.data); // Reselect the same person
            showFeedback("Informations mises à jour.", "success");
        });
        
        // Bouton Supprimer
        document.getElementById('delete-btn').addEventListener('click', () => {
            if (confirm(`Êtes-vous sûr de vouloir supprimer ${selectedPerson.name} et toute sa descendance ?`)) {
                if (selectedD3Node.depth === 0) {
                    alert("Impossible de supprimer la racine de l'arbre.");
                    return;
                }
                const isSpouse = selectedPerson !== selectedD3Node.data;
                if (isSpouse) {
                    delete selectedD3Node.data.spouse;
                } else {
                    const parentChildren = selectedD3Node.parent.data.children;
                    const index = parentChildren.findIndex(child => child.name === selectedPerson.name);
                    parentChildren.splice(index, 1);
                }
                saveData();
                renderTree();
                detailsPanel.classed("visible", false);
            }
        });

        // Formulaire Ajouter un enfant
        document.getElementById('add-child-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const name = e.target.elements['name'].value.trim();
            if (!name) return;
            if (!Array.isArray(selectedPerson.children)) {
                selectedPerson.children = [];
            }
            selectedPerson.children.push({ name: name, children: [] });
            saveData();
            renderTree();
            e.target.reset();
            showFeedback(`"${name}" ajouté(e) comme enfant.`, "success");
        });

        // Formulaire Ajouter un conjoint
        document.getElementById('add-spouse-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const name = e.target.elements['name'].value.trim();
            if (!name || selectedPerson.spouse) return;
            selectedPerson.spouse = { name: name };
            saveData();
            renderTree();
            showDetails(selectedD3Node); // Refresh panel
            showFeedback(`"${name}" ajouté(e) comme conjoint.`, "success");
        });

        // --- 6. INITIALISATION ---
        loadData();
        renderTree();
        window.addEventListener("resize", renderTree);
    </script>
</body>
</html>
